function TIMCEpisode(e,i,o,s,a){return{index:e,id:i,nextId:o,prevId:s,ytid:a}}function coverVisibility(e,i){i?(e.find(".summary").removeClass("off"),e.find(".play-button").removeClass("off"),e.find(".cover").removeClass("off"),e.find(".media").removeClass("on")):(e.find(".summary").addClass("off"),e.find(".play-button").addClass("off"),e.find(".cover").addClass("off"),e.find(".media").addClass("on"))}function showMap(e){for(var i=activeMarkers.length;i--;)activeMarkers[i].setMap(null),activeMarkers.splice(i,1);var o=new google.maps.LatLngBounds;e.find("li[data-geo]").each(function(){var e=this,i=$(this),s=i.find("h4").text(),a=i.data("geo").split(","),n=new google.maps.LatLng(a[1],a[0]);o.extend(n);var l=new google.maps.Marker({position:n,title:s,icon:createMarkerIcon("images/p_mkr.svg"),draggable:!1,map:map});activeMarkers.push(l),i.data("marker",l),google.maps.event.addListener(l,"click",function(i){i.stop(),viewModel.selectedItin(e)}),map.fitBounds(o)})}function selectDay(e){e.siblings(".close-button").removeClass("location");var i=e.next("ul").find("li"),o=new google.maps.LatLngBounds;i.each(function(){var e=$(this).data("marker");o.extend(e.getPosition())}),map.fitBounds(o)}function createMarkerIcon(e){return new google.maps.MarkerImage(e,null,null,null,new google.maps.Size(ICON_SIZE,ICON_SIZE))}function selectLocation(e){if(null!=e){var i=e.parent("ul").prev("h3");viewModel.selectedDay()!=i[0]&&viewModel.selectedDay(i[0]),i.siblings(".close-button").addClass("location");var o=e.data("marker");map.panTo(o.getPosition()),o.setIcon(createMarkerIcon("images/w_mkr.svg")),o.setZIndex(MARKER_ZINDEX++);var s=e.data("zoom")||LOCATION_ZOOM;map.setZoom(s)}}$.preload=function(){var e=arguments.length>1?arguments:arguments[0];if($.isArray(e))return $.when.apply(window,$.map(e,function(e){return $.preload(e)}));var i=$.Deferred(),o=new Image;return o.onload=function(){i.resolve(o)},o.onerror=function(){i.reject(o)},o.src=e,i.promise()},ko.observable.fn.mySubscribe=function(e,i){var o;this.subscribe(function(e){o=e},null,"beforeChange"),this.subscribe(function(s){e.call(i,o,s)})};var episodes={},map=null,activeMarkers=[],DEFAULT_EPISODE_ID="ep_3",MARKER_ZINDEX,LOCATION_ZOOM=14,ICON_SIZE=24,preloadersArr=["images/pre_1.gif","images/pre_2.gif","images/pre_3.gif","images/pre_4.gif","images/pre_5.gif","images/pre_6.gif","images/pre_7.gif","images/pre_8.gif","images/pre_9.gif"],mapstyles=[{stylers:[{saturation:-100},{lightness:-75}]},{elementType:"labels.text.stroke",stylers:[{visibility:"off"}]},{elementType:"labels.text.fill",stylers:[{lightness:39}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{elementType:"geometry",stylers:[{weight:1}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{lightness:-100}]}],viewModel={epId:ko.observable(),secondaryId:ko.observable(),selectedSide:ko.observable(),selectedDay:ko.observable(),selectedItin:ko.observable(),playingVideoId:ko.observable()};viewModel.selectedEp=ko.computed(function(){var e=this.epId();return e?$("#"+e)[0]:null},viewModel),viewModel.$selectedEp=ko.computed(function(){return $(this.selectedEp())},viewModel),viewModel.selectedSecondary=ko.computed(function(){var e=this.secondaryId();return e?$("#"+e)[0]:null},viewModel),viewModel.epId.mySubscribe(function(e,i){if(e!=i){viewModel.secondaryId(null),viewModel.selectedSide(null),viewModel.playingVideoId(null);var o=null;e&&(o=$("#"+e)),location.hash="#"+i;var s=$("#"+i),a=s.find(".cover"),n=a.data("src").split(","),l=Math.floor(Math.random()*n.length),t=preloadersArr[Math.floor(Math.random()*preloadersArr.length)],d=$('<div class="loader"/>').css({backgroundImage:"url("+t+")"});a.css({backgroundImage:"none"}),a.append(d);var r=new Image;if($(r).on("load",function(){d.remove(),a.css({backgroundImage:"url("+n[l]+")"})}),r.src=n[l],o){var c=episodes[i].index-episodes[e].index,p=_.size(episodes)-1;1==c||c==-1*p?(s.css({left:"100%"}),o.css({left:"0%"}),s.animate({left:"0%"}),o.animate({left:"-100%"},function(){o.addClass("off")})):-1==c||c==p?(s.css({left:"-100%"}),o.css({left:"0%"}),s.animate({left:"0%"}),o.animate({left:"100%"},function(){o.addClass("off")})):(s.css({left:"0%"}),o.addClass("off"))}s.removeClass("off");var v=s.find(".bios"),u=s.find(".music"),f=s.find(".itinerary");v.length&&u.length&&f.length?($("ul#episode-side-nav li").show(),v.hide(),u.hide(),f.hide()):$("ul#episode-side-nav li").hide()}}),viewModel.selectedSide.mySubscribe(function(e,i){if(e!=i){if(i&&viewModel.playingVideoId(null),null==i);else if("map"==i){var o=viewModel.$selectedEp().find(".itinerary");o.show(),showMap(o)}else"bios"==i?viewModel.$selectedEp().find(".bios").show():"music"==i&&viewModel.$selectedEp().find(".music").show();null==e?viewModel.secondaryId(null):"map"==e?viewModel.$selectedEp().find(".itinerary").hide():"bios"==e?viewModel.$selectedEp().find(".bios").hide():"music"==e&&viewModel.$selectedEp().find(".music").hide()}}),viewModel.secondaryId.mySubscribe(function(e,i){e!=i&&(i?(viewModel.playingVideoId(null),viewModel.selectedSide(null),$("#nav").removeClass("on")):viewModel.selectedEp()&&(location.hash="#"+viewModel.selectedEp().id))}),viewModel.selectedDay.mySubscribe(function(e,i){e!=i&&selectDay($(i))}),viewModel.selectedItin.mySubscribe(function(e,i){e!=i&&(e&&$(e).removeClass("on").data("marker").setIcon(createMarkerIcon("images/p_mkr.svg")),val=i?$(i):null,selectLocation(val),val&&val.addClass("on"))}),viewModel.playingVideoId.mySubscribe(function(e,i){if(e!=i){if(null!=i){viewModel.selectedSide(null),viewModel.secondaryId(null);var o=$("#"+i);coverVisibility(o,!1);var s=episodes[i],a=s.ytid;s.player?s.player.loadVideoById(a):s.player=new YT.Player(o.find(".media")[0],{height:"100%",width:"100%",videoId:a,playerVars:{autoplay:1,modestbranding:1,rel:0,hd:1,origin:"http://www.thisismycity.tv"}})}if(null!=e){var n=$("#"+e),s=episodes[e];s.player&&s.player.pauseVideo(),n.removeClass("off"),coverVisibility(n,!0)}}}),$(window).on("hashchange",function(){var e=location.hash.substr(1);episodes[e]?viewModel.epId(e):("about"==e||"press"==e||"contact"==e||"mailing"==e)&&viewModel.secondaryId(e)}),$(function(){var e=$("#episode-media>li");e.each(function(i,o){var s=$(o),a=s.next(),n=s.prev();a.length||(a=e.first()),n.length||(n=e.last()),episodes[o.id]=new TIMCEpisode(i,o.id,a[0].id,n[0].id,s.data("ytid"))});var i=location.hash;$.preload(preloadersArr).done(function(){var e=DEFAULT_EPISODE_ID;i&&(sid=i.substr(1),episodes[sid]&&(e=sid)),viewModel.epId(e)}),$("#stop-episode.close-button").click(function(){viewModel.playingVideoId(null)}),$("#secondary-content").find(".close-button").click(function(){viewModel.secondaryId(null)}),$("#map-button").click(function(){"map"==viewModel.selectedSide()?viewModel.selectedSide(null):viewModel.selectedSide("map")}),$("#bios-button").click(function(){viewModel.selectedSide("bios")}),$("#music-button").click(function(){viewModel.selectedSide("music")}),$("#episodes-nav li a").mouseenter(function(){$(this).parent().find("div.bg").addClass("on")}).mouseleave(function(){$(this).parent().find("div.bg").removeClass("on")}),$("div.play-button").mouseenter(function(){$(this).parent().find(".cover").addClass("active")}).mouseleave(function(){$(this).parent().find(".cover").removeClass("active")}).click(function(e){var i=$(e.target).data("target");viewModel.playingVideoId(i)}),$("#next-episode").click(function(){var e=viewModel.epId();viewModel.epId(episodes[e].nextId)}),$("#previous-episode").click(function(){var e=viewModel.epId();viewModel.epId(episodes[e].prevId)}),$("#nav-toggle").click(function(){$("#nav").addClass("on")}),$("#nav .close-button").click(function(){$("#nav").removeClass("on")});var o=$(".itinerary");o.find("h3").click(function(){viewModel.selectedDay(this)}),o.find("li").click(function(){viewModel.selectedItin(this)}),$("#episode-media .close-button").click(function(){viewModel.selectedSide(null)}),ko.applyBindings(viewModel),MARKER_ZINDEX=google.maps.Marker.MAX_ZINDEX,google.maps.visualRefresh=!0;var s=new google.maps.StyledMapType(mapstyles,{name:"Styled Map"}),a={disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.TERRAIN,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.DEFAULT,position:google.maps.ControlPosition.RIGHT_CENTER}};map=new google.maps.Map(document.getElementById("map-area"),a),map.mapTypes.set("map_style",s),map.setMapTypeId("map_style"),google.maps.event.addListener(map,"zoom_changed",function(){var e=100,i=map.getZoom(),o=Math.round(2*i);o>e&&(o=e),ICON_SIZE=o;for(var s=activeMarkers.length;s--;){var a=activeMarkers[s];a.setIcon(createMarkerIcon(a.getIcon().url))}})});